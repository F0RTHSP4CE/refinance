# refinance
![logo](docs/refinance-logo.jpg)

refined financial system for a hackerspace. simple by design.

## architecture

### entity
anything that can send or receive money: human, donate-box, rent, utility.

### transaction
move X from A to B. supports all currencies.
- non-confirmed
- confirmed

### balance
sum of all transactions. both confirmed and not. separated.

### tags
mark entities and transactions for quick search.

## authentication
- you can request a login link with your entity name, telegram id, signal id or whatever.
- login link will be sent to all available destinations (telegram, signal, email, etc)
- new login link does not revoke old ones, so no one can deauthenticate you.

### OIDC Authentication
In addition to the traditional token-based authentication, the system supports OpenID Connect (OIDC) authentication:

- Configure OIDC provider settings via environment variables
- Supports standard OIDC providers (Google, Microsoft, Auth0, etc.)
- Users can link multiple authentication methods to one account
- Secure authorization code flow with PKCE

#### OIDC Configuration
To enable OIDC authentication, set the following environment variables:

```bash
# Required
export REFINANCE_OIDC_CLIENT_ID=your-oidc-client-id
export REFINANCE_OIDC_CLIENT_SECRET=your-oidc-client-secret
export REFINANCE_OIDC_DISCOVERY_URL=https://your-provider.com/.well-known/openid_configuration

# Optional (defaults to "openid profile email")
export REFINANCE_OIDC_SCOPES=openid profile email
```

#### OIDC Provider Examples
- **Google**: `https://accounts.google.com/.well-known/openid_configuration`
- **Microsoft**: `https://login.microsoftonline.com/common/v2.0/.well-known/openid_configuration`
- **Auth0**: `https://your-domain.auth0.com/.well-known/openid_configuration` 

## production

put secrets into `secrets.env`. see `secrets.env.example` as a reference. 

```console
make prod-daemon
```

API: http://0.0.0.0:8000/docs
UI: http://0.0.0.0:9000

## development

### create local environment with all dependencies
```console
uv python install 3.12
uv sync --dev
```

open project in vscode, <kbd>F1</kbd> `python.setInterpreter`, select `.venv` (workspace)

if you need to change project deps:
```console
uv add packagename
uv remove packagename
uv sync
```

### tests
```
make test
```

### run backend & frontend with live code reload
```
make dev
```
open http://localhost:8000/docs and http://localhost:9000

## todo release
- [x] base classes
- [x] errors
- [x] unit tests
- [x] complex search
- [x] pagination
- [x] tags
- [x] transactions
- [x] balances
- [x] balance cache
- [x] date range search
- [x] payment splits
- [x] multiple auth providers
- [x] docker
- [x] authentication?
- [x] pytest ci
- [x] generic deposit service
- [x] usdt top-up
- [x] currency exchange
- [x] unit of work?
- [x] fixed amount participation in split
- [x] add split participants by a tag
- [x] ~~grafana~~, statistics
- [x] treasuries
- [ ] logging
- [ ] permissions?
- [ ] misc validation of amounts (>0.00)
- [ ] improve split ux
- [ ] pass tags as a list, not as add/delete operations
- [ ] migrations

## todo techdebt
- [ ] make a uniform deposit api CRUD, provider should be enum
- [ ] update all boolean attrs to status enums
- [ ] mobile ui
- [ ] rename base to common where applicable
- [ ] ~~remove _in and _out postfixes for entities~~ not needed
- [ ] remove base service class

## todo future features
- [ ] deposit ui
- [ ] donation categories (entities?)
- [ ] easy payment urls
- [ ] card processing

## tests notice
tests are mostly autogenerated by llm, given the route and schema. human review would be beneficial. 

## license
MIT
