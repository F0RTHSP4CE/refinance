{% extends 'base.jinja2' %}

{% block title %}Pay Member/Resident Fee{% endblock %}

{% block content %}
<div class="deposit-topup-layout shortcut-form-container">
    <section class="deposit-topup-card">
        <form method="post" class="deposit-topup-form">
            <input type="hidden" name="from_entity_id" value="{{ g.actor_entity.id }}">
            <input type="hidden" name="to_entity_id" value="{{ f0_entity_id }}">

            <div class="form-group">
                <label class="form-label" for="fee_preset">Preset</label>
                <select id="fee_preset" name="fee_preset" class="form-input">
                    {% for preset in fee_presets %}
                    <option value="{{ preset.value }}" {% if preset.value==default_fee_preset %}selected{% endif %}>
                        {{ preset.label }}
                    </option>
                    {% endfor %}
                    <option value="custom" {% if default_fee_preset=="custom" %}selected{% endif %}>Custom</option>
                </select>
            </div>

            <div class="deposit-row" id="custom_row" style="display: none;">
                <div class="deposit-field deposit-field-amount">
                    <label class="form-label" for="custom_amount">Custom Amount</label>
                    <input id="custom_amount" name="custom_amount" class="form-input" type="number" step="0.01"
                        placeholder="10.00">
                </div>

                <div class="deposit-field deposit-field-currency">
                    <label class="form-label" for="custom_currency">Custom Currency</label>
                    <select id="custom_currency" name="custom_currency" class="form-input">
                        <option value="GEL" selected>GEL</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="comment">Comment</label>
                <select id="comment" name="comment" class="form-input">
                    {% for option in comment_options %}
                    <option value="{{ option }}" {% if option==default_comment %}selected{% endif %}>
                        {{ option }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="deposit-topup-actions">
                <button type="submit" class="big-button">Pay</button>
            </div>
        </form>
    </section>
</div>

{% if fee_row %}
<h2>Your fee history</h2>
{% set month_names = ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"] %}
<table>
    <thead>
        <tr>
            <th></th>
            {% for month in fee_row.fees %}
            {% if month.month==current_month and month.year==current_year %}
            <th class="center-align">â–¼</th>
            {% else %}
            <th></th>
            {% endif %}
            {% endfor %}
        </tr>
    </thead>
    <thead>
        <tr>
            <th></th>
            {% for month in fee_row.fees %}
            <th class="center-align">
                {{ month_names[month.month] }} {{ month.year }}
            </th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
                <a href="{{ url_for('entity.detail', id=fee_row.entity.id) }}"
                    class="{% if not fee_row.entity.active %}secondary inactive{% endif %}">{{
                    fee_row.entity.name
                    }}</a>
            </td>
            {% for fee in fee_row.fees %}
            {% set is_future = fee.year > current_year or (fee.year == current_year and fee.month > current_month) %}
            <td {% if fee.amounts %} class="fee-paid" {% elif not is_future %} class="fee-not-paid" {% endif %}>
                {% if fee.amounts %}
                {% for currency, amount in fee.amounts.items() %}
                <div>{{ " %.2f"|format(amount|float) }} {{ currency | upper }} </div>
                {% endfor %}
                {% endif %}
            </td>
            {% endfor %}
        </tr>
    </tbody>
</table>
{% else %}
<p>No fee history for this entity.</p>
{% endif %}

<script>
    const feePreset = document.querySelector('select[name="fee_preset"]');
    const customRow = document.getElementById('custom_row');

    const updateCustomAmountVisibility = () => {
        const isCustom = feePreset.value === 'custom';
        customRow.style.display = isCustom ? '' : 'none';
    };

    feePreset.addEventListener('change', updateCustomAmountVisibility);
    updateCustomAmountVisibility();
</script>

<h2>What is a Fee?</h2>
<p>Fee is a monthly payment from a resident/member to the hackerspace. It is used to pay for rent and utilities.</p>
<h2>How to pay it?</h2>
<ol>
    <li><a href="{{ url_for('transaction.shortcut_deposit') }}">Deposit funds</a></li>
    <li>Select a month and an amount</li>
    <li>Click Pay</li>
    <li>Repeat to pay for <strong>future months</strong></li>
</ol>
<img src="{{ url_for('static', filename='/images/transaction/shortcuts/fee.jpg') }}" alt="Monthly Fee Diagram"
    style="max-width: 50rem">

{% endblock %}