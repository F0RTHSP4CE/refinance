{% extends "base.jinja2" %}

{% from 'widgets/tag_inline.jinja2' import tag_inline %}

{% block title %}Resident Fee{% endblock %}
{% block content %}
{% set month_names = ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"] %}
<table>
    <thead>
        <tr>
            <th></th>
            <th></th>
            {% for month in fees[0].fees %}
            {% if month.month==current_month and month.year==current_year %}
            <th class="center-align">▼</th>
            {% else %}
            <th></th>
            {% endif %}
            {% endfor %}
            <th></th>
        </tr>
    </thead>
    <thead>
        <tr>
            <th>#</th>
            <th></th>
            {% if fees %}
            {% for month in fees[0].fees %}
            <th class="center-align">
                {{ month_names[month.month] }} {{ month.year }}
            </th>
            {% endfor %}
            {% endif %}
            <th class="center-align">Graph</th>
        </tr>
    </thead>
    <tbody>
        {% for resident_fee in fees %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>
                <a href="{{ url_for('entity.detail', id=resident_fee.entity.id) }}">{{
                    resident_fee.entity.name
                    }}</a>
                {% for tag in resident_fee.entity.tags %}
                {{ tag_inline(tag) }}
                {% endfor %}
            </td>

            {% for fee in resident_fee.fees %}
            {% set is_future = fee.year > current_year or (fee.year == current_year and fee.month > current_month) %}
            <td {% if fee.amounts %} class="fee-paid" {% elif not is_future %} class="fee-not-paid" {% endif %}>
                {% if fee.amounts %}
                {% for currency, amount in fee.amounts.items() %}
                <div>{{ " %.2f"|format(amount|float) }} {{ currency | upper }} </div>
                {% endfor %}
                {% else %}

                {% endif %}
            </td>
            {% endfor %}
            <td class="fee-trend-cell">
                {% if resident_fee.sparkline_points %}
                <svg class="fee-trend-graph" width="90" height="24" viewBox="0 0 90 24" preserveAspectRatio="none"
                    aria-hidden="true" focusable="false">
                    <polyline points="{{ resident_fee.sparkline_points }}" fill="none" stroke="#111" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round" />
                    {% if resident_fee.sparkline_last_point %}
                    <circle cx="{{ '%.2f'|format(resident_fee.sparkline_last_point[0]) }}"
                        cy="{{ '%.2f'|format(resident_fee.sparkline_last_point[1]) }}" r="2" fill="#007bff" />
                    {% endif %}
                </svg>
                {% else %}
                <span class="fee-trend-empty">–</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}