{% extends "base.jinja2" %}
{% from 'widgets/tag_inline.jinja2' import tag_inline %}
{% from 'widgets/pagination.jinja2' import pagination_control %}
{% from 'form.jinja2' import render_form %}

{% block title %}Entities{% endblock %}
{% block content %}
<p><a href="{{ url_for('entity.add') }}">Add</a></p>

<p>
<details>
    <summary>search</summary>
    <p>
    <form method="get">
        {{ render_form(filter_form, except=('csrf_token')) }}
    </form>
    </p>
</details>
</p>

{% if entities %}
<div class="wide-table-wrapper">
    <table>
        <thead>
            <tr>
                <td>Name</td>
                <td>Tags</td>
                {% for currency in currency_columns %}
                <td class="right-align">{{ currency | upper }}</td>
                {% endfor %}
                <td>Comment</td>
            </tr>
        </thead>
        <tbody>
            {% for entity in entities %}
            {% set balance = balances.get(entity.id) %}
            <tr>
                <td>
                    <a href="{{ url_for('entity.detail', id=entity.id) }}"
                        class="{% if not entity.active %}secondary inactive{% endif %}">
                        {{ entity.name }}
                    </a>
                </td>
                <td>
                    {% for tag in entity.tags %}
                    {{ tag_inline(tag) }}
                    {% endfor %}
                </td>
                {% for currency in currency_columns %}
                {% set completed_amount = balance.completed.get(currency) if balance else None %}
                {% set draft_amount = balance.draft.get(currency) if balance else None %}
                <td class="balance-cell right-align">
                    {% if completed_amount is not none and completed_amount|float != 0 %}
                    <div class="balance-value {% if completed_amount|float < 0 %}amount-negative{% endif %}">
                        {{ completed_amount }}
                    </div>
                    {% endif %}
                    {% if draft_amount is not none and draft_amount|float != 0 %}
                    <div class="balance-draft {% if draft_amount|float < 0 %}amount-negative{% endif %}">
                        {{ draft_amount }}*
                    </div>
                    {% endif %}
                </td>
                {% endfor %}
                <td>{{ entity.comment or ""}}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>No entities.</p>
{% endif %}
{{ pagination_control(page, total, limit, 'entity.list') }}
{% endblock %}