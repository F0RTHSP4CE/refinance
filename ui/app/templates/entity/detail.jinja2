{% extends "base.jinja2" %}
{% from "transaction/macro_list.jinja2" import transaction_list with context %}
{% from "invoice/macro_list.jinja2" import invoice_list with context %}
{% from 'widgets/tag_inline.jinja2' import tag_inline %}
{% from 'widgets/pagination.jinja2' import pagination_control %}

{% block title %}Entity <span class="{% if not entity.active %}secondary inactive{% endif %}">{{ entity.name }}</span>{%
endblock %}

{% block content %}
<style>
    .top-section {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .details-balance {
        flex: 0 0 auto;
        min-width: 300px;
    }

    .stats {
        flex: 1 1 0;
    }

    @media (max-width: 1200px) {
        .top-section {
            flex-direction: column;
        }
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 20px;
    }

    .chart-cell {
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(248, 250, 252, 0.9), rgba(241, 245, 249, 0.9));
        border: 1px solid rgba(226, 232, 240, 0.8);
        box-sizing: border-box;
    }

    .charts-grid>.chart-cell:first-child {
        grid-column: 1 / -1;
        justify-self: start;
    }

    .charts-grid.balance-width-one>.chart-cell:first-child {
        width: calc((100% - 20px) / 2);
    }

    .charts-grid.balance-width-full>.chart-cell:first-child {
        width: 100%;
    }

    @media (max-width: 900px) {
        .charts-grid>.chart-cell:first-child {
            width: 100%;
        }
    }

    .chart-cell h2 {
        margin: 0;
        color: #1e293b;
        font-size: 1.05rem;
        letter-spacing: 0.01em;
    }

    .chart-cell canvas {
        width: 100% !important;
        height: auto !important;
    }

    .balance-chart-container {
        width: 100%;
        max-width: 100%;
        min-height: 380px;
        height: 460px;
        max-height: 70vh;
        overflow: hidden;
        box-sizing: border-box;
    }

    .charts-grid.balance-width-full .balance-chart-container {
        min-height: 760px;
        height: 920px;
        max-height: none;
    }

    #balance-change-chart {
        width: 100%;
        height: 100%;
    }

    .activity-charts {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: stretch;
        justify-content: space-around;
    }

    .bar-chart {
        flex: 0 1 260px;
        min-width: 220px;
        max-width: 300px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: relative;
        height: 320px;
    }

    .bar-chart h3 {
        font-size: 0.95rem;
        font-weight: 600;
        color: #334155;
        margin: 0;
    }

    .bar-chart canvas {
        flex: 1 1 auto;
        width: 100% !important;
        height: 100% !important;
        max-height: none;
    }

    .pie-chart {
        flex: 0 1 300px;
        min-width: 220px;
        max-width: 320px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .pie-chart h3 {
        font-size: 0.95rem;
        font-weight: 600;
        color: #334155;
        margin: 0;
        text-align: center;
    }

    .pie-chart canvas {
        width: 100% !important;
        max-width: 300px;
    }

    @media (max-width: 900px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .chart-cell {
            min-width: 0;
        }

        .activity-charts {
            justify-content: center;
        }
    }

    @media (max-width: 600px) {

        .bar-chart,
        .pie-chart {
            flex: 1 1 100%;
            max-width: 100%;
        }

        .bar-chart {
            height: 260px;
        }

        .pie-chart {
            max-width: 320px;
        }
    }

    .stats-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }

    .stats-controls span {
        color: #475569;
    }

    .stats-controls a {
        padding: 4px 10px;
        border-radius: 6px;
        background: #e2e8f0;
        color: inherit;
        text-decoration: none;
        transition: background 0.2s ease;
    }

    .stats-controls a:hover {
        background: #cbd5f5;
    }

    .stats-controls a.active {
        background: #2563eb;
        color: #fff;
    }

    .stats-controls button {
        padding: 4px 10px;
        border-radius: 6px;
        background: #e2e8f0;
        color: inherit;
        border: 0;
        cursor: pointer;
        transition: background 0.2s ease;
        font: inherit;
    }

    .stats-controls button:hover {
        background: #cbd5f5;
    }

    .stats-controls button.active {
        background: #2563eb;
        color: #fff;
    }

    .stats-controls .divider {
        color: #94a3b8;
        margin: 0 4px;
    }

    .chart-placeholder {
        color: #6b7280;
        font-style: italic;
        margin: 1rem 0;
    }
</style>
<div class="top-section">
    <div class="details-balance">
        <h2>Details</h2>
        <p>
        <table>
            <tr>
                <td>ID</td>
                <td>{{ entity.id }}</td>
            </tr>
            <tr>
                <td>Name</td>
                <td><span class="{% if not entity.active %}secondary inactive{% endif %}">{{entity.name}}</span></td>
            </tr>
            <tr>
                <td>Comment</td>
                <td>{{ entity.comment or "" }}</td>
            </tr>
            <tr>
                <td>Tags</td>
                <td>
                    {% for tag in entity.tags %}
                    {{ tag_inline(tag) }}
                    {% endfor %}
                </td>
            </tr>
            <tr>
                <td>Active</td>
                <td>{{ entity.active }}</td>
            </tr>
            <tr>
                <td>Created at</td>
                <td>{{ human_readable_date(entity.created_at) }}</td>
            </tr>
            <tr>
                <td>Modified at</td>
                <td>{{ human_readable_date(entity.modified_at) if entity.modified_at else "" }}</td>
            </tr>
            <tr>
                <td>Authentication</td>
                <td>
                    {% if entity.auth %}
                    <table>
                        <thead>
                            <tr>
                                <th>Provider</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set labels = {
                            "telegram_id": "Telegram ID",
                            "signal_id": "Signal ID",
                            "whatsapp_number": "WhatsApp Number",
                            "email": "Email"
                            } %}
                            {% for key, value in entity.auth.items() %}
                            <tr>
                                <td>{{ labels.get(key, key.replace('_', ' ').title()) }}</td>
                                <td>{{ value or " "}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
        </table>
        </p>

        <p><a href="{{ url_for('entity.edit', id=entity.id) }}">Edit</a></p>

        <h2>Balance</h2>

        {% if not balance.draft and not balance.completed %}
        <p>No transactions.</p>
        {% endif %}

        {% if balance.completed %}
        <p>
            Completed:
        <table>
            {% for currency,amount in balance.completed.items() %}
            <tr>
                <td class="right-align {% if amount|float < 0 %}amount-negative{% endif %}">
                    {{ amount}}
                </td>
                <td>{{ currency | upper }}</td>
            </tr>
            {% endfor %}
        </table>
        </p>
        {% endif %}

        {% if balance.draft %}
        <p>
            Draft (<a href="{{ url_for('transaction.list', entity_id=entity.id, status='draft') }}">Find</a>):
        <table>
            {% for currency,amount in balance.draft.items() %}
            <tr>
                <td class="right-align {% if amount|float < 0 %}amount-negative{% endif %}">
                    {{ amount}}
                </td>
                <td>{{ currency | upper }}</td>
            </tr>
            {% endfor %}
        </table>
        </p>
        {% endif %}
    </div>
    <div class="stats">
        <h2>Statistics</h2>
        {% if not stats_loaded %}
        <p>
            <a
                href="{{ url_for('entity.stats', id=entity.id, page=page, limit=limit, stats_months=stats_months, stats_limit=stats_limit) }}">
                Calculate statistics
            </a>
        </p>
        {% else %}
        <!-- Entity stats charts -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
        <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
        <div class="stats-controls">
            <span>Timeframe:</span>
            {% for months_option in [3, 6, 12] %}
            <a href="{{ update_query_params(stats_months=months_option) }}"
                class="{% if stats_months == months_option %}active{% endif %}">{{ months_option }}m</a>
            {% endfor %}
            <span class="divider">|</span>
            <span>Top entries:</span>
            {% for limit_option in [5, 8, 12] %}
            <a href="{{ update_query_params(stats_limit=limit_option) }}"
                class="{% if stats_limit == limit_option %}active{% endif %}">{{ limit_option }}</a>
            {% endfor %}
            <span class="divider">|</span>
            <span>Scale:</span>
            <button id="balance-scale-linear" type="button" class="active">Linear</button>
            <button id="balance-scale-log" type="button">Log</button>
            <span class="divider">|</span>
            <span>Width:</span>
            <button id="balance-width-one" type="button" class="active">1 Column</button>
            <button id="balance-width-full" type="button">Full Width</button>
        </div>
        <div id="entity-stats-charts-grid" class="charts-grid balance-width-one">
            <div class="chart-cell">
                <h2>Balance Change by Day</h2>
                <div id="balance-chart-container" class="balance-chart-container">
                    <div id="balance-change-chart"></div>
                </div>
            </div>
            <div class="chart-cell">
                <h2>Incoming Activity (last {{ stats_months }} months)</h2>
                <div class="activity-charts">
                    <div class="bar-chart">
                        <h3>Top Income Sources</h3>
                        {% if top_incoming %}
                        <canvas id="top-incoming-chart"></canvas>
                        {% else %}
                        <p class="chart-placeholder">No incoming transactions in the selected timeframe.</p>
                        {% endif %}
                    </div>
                    <div class="pie-chart">
                        <h3>Top Incoming Tags</h3>
                        {% if top_incoming_tags %}
                        <canvas id="top-incoming-tags-chart"></canvas>
                        {% else %}
                        <p class="chart-placeholder">No tagged incoming activity in the selected timeframe.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="chart-cell">
                <h2>Outgoing Activity (last {{ stats_months }} months)</h2>
                <div class="activity-charts">
                    <div class="bar-chart">
                        <h3>Top Expense Destinations</h3>
                        {% if top_outgoing %}
                        <canvas id="top-outgoing-chart"></canvas>
                        {% else %}
                        <p class="chart-placeholder">No outgoing transactions in the selected timeframe.</p>
                        {% endif %}
                    </div>
                    <div class="pie-chart">
                        <h3>Top Outgoing Tags</h3>
                        {% if top_outgoing_tags %}
                        <canvas id="top-outgoing-tags-chart"></canvas>
                        {% else %}
                        <p class="chart-placeholder">No tagged outgoing activity in the selected timeframe.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <script>
            const balanceData = {{ balance_changes | tojson }};
            const txDayData = {{ transactions_by_day | tojson }};
            const topIncoming = {{ top_incoming | tojson }};
            const topOutgoing = {{ top_outgoing | tojson }};
            const topIncomingTags = {{ top_incoming_tags | tojson }};
            const topOutgoingTags = {{ top_outgoing_tags | tojson }};

            const formatUSD = (value) => {
                if (!Number.isFinite(value)) {
                    return "$0.00";
                }
                return `$${value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };

            const hashString = (value) => {
                const str = String(value ?? "");
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = (hash << 5) - hash + str.charCodeAt(i);
                    hash |= 0; // Convert to 32bit integer
                }
                return hash;
            };

            const colorFromIdentifier = (identifier, fallbackIndex) => {
                const key = identifier ?? `fallback-${fallbackIndex}`;
                const hash = Math.abs(hashString(String(key)));
                const hue = (hash * 137.508) % 360;
                const saturation = 55 + (hash % 30); // 55% - 84%
                const lightness = 42 + ((hash >> 3) % 28); // 42% - 69%
                const hoverLightness = Math.min(92, lightness + 30);
                const hoverSaturation = Math.min(50, saturation + 6);

                return {
                    base: `hsl(${hue.toFixed(1)}, ${saturation}%, ${lightness}%)`,
                    hover: `hsl(${hue.toFixed(1)}, ${hoverSaturation}%, ${hoverLightness}%)`,
                };
            };

            const buildPalette = (items, keyBuilder) => {
                const bases = [];
                const hovers = [];
                items.forEach((item, index) => {
                    const identifier = keyBuilder(item, index);
                    const { base, hover } = colorFromIdentifier(identifier, index);
                    bases.push(base);
                    hovers.push(hover);
                });
                return { bases, hovers };
            };

            const buildEntityColors = (items) => buildPalette(
                items,
                (item, index) => item.entity_id ?? `entity-${index}`,
            );

            const buildTagColors = (items) => buildPalette(
                items,
                (item, index) => `tag-${item.tag_id ?? index}`,
            );

            const buildDoughnutOptions = (dataValues) => {
                const total = dataValues.reduce((sum, current) => sum + current, 0) || 1;
                return {
                    cutout: '55%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatUSD(value)} (${percentage}%)`;
                                },
                            },
                        },
                    },
                };
            };

            const buildDoughnutDataset = (values, colors, hoverColors) => ({
                data: values,
                backgroundColor: colors,
                borderColor: '#f8fafc',
                borderWidth: 2,
                spacing: 2,
                hoverOffset: 10,
                hoverBackgroundColor: hoverColors ?? colors,
            });

            const buildBarDataset = (values, colors, hoverColors) => ({
                label: 'Total (USD)',
                data: values,
                backgroundColor: colors,
                hoverBackgroundColor: hoverColors ?? colors,
                borderColor: colors.map(() => 'rgba(148, 163, 184, 0.35)'),
                borderWidth: 1,
                barPercentage: 1,
                categoryPercentage: 1,
                maxBarThickness: 32,
            });

            const buildVerticalBarOptions = () => ({
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            autoSkip: false,
                            maxRotation: 35,
                            minRotation: 0,
                        },
                        grid: {
                            display: false,
                        },
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => formatUSD(Number(value)),
                        },
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)',
                        },
                    },
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const value = context.parsed.y ?? context.parsed;
                                return `${context.label}: ${formatUSD(Number(value))}`;
                            },
                        },
                    },
                },
            });

            const createVerticalBarChart = (canvasId, labels, values, colors) => {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                return new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            buildBarDataset(values, colors.bases, colors.hovers),
                        ],
                    },
                    options: buildVerticalBarOptions(),
                });
            };
            const buildBalancePlotlyChart = () => {
                const chartContainer = document.getElementById('balance-change-chart');
                const chartsGrid = document.getElementById('entity-stats-charts-grid');
                const oneColumnButton = document.getElementById('balance-width-one');
                const fullWidthButton = document.getElementById('balance-width-full');
                if (!chartContainer || typeof Plotly === 'undefined') return;

                const currencies = new Set();
                balanceData.forEach((item) => {
                    Object.keys(item.balance_changes || {}).forEach((currency) => currencies.add(currency));
                });

                const traces = [];
                Array.from(currencies).sort().forEach((currency) => {
                    const color = colorFromIdentifier(currency, 0).base;
                    traces.push({
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: currency.toUpperCase(),
                        visible: 'legendonly',
                        x: balanceData.map((item) => item.day),
                        y: balanceData.map((item) => Number((item.balance_changes || {})[currency] || 0)),
                        line: { width: 2, color },
                        marker: { size: 4, color },
                        hovertemplate: `%{x}<br>${currency.toUpperCase()}: %{y:.2f}<extra></extra>`,
                    });
                });

                traces.push({
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Total (USD)',
                    x: balanceData.map((item) => item.day),
                    y: balanceData.map((item) => Number(item.total_usd || 0)),
                    line: { width: 2.5, color: 'rgba(37, 99, 235, 0.95)' },
                    marker: { size: 5, color: 'rgba(37, 99, 235, 0.95)' },
                    hovertemplate: '%{x}<br>Total (USD): %{y:.2f}<extra></extra>',
                });

                const layout = {
                    margin: { l: 52, r: 16, t: 8, b: 42 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(248, 250, 252, 0.6)',
                    hovermode: 'x unified',
                    dragmode: 'pan',
                    legend: {
                        orientation: 'h',
                        yanchor: 'bottom',
                        y: 1.02,
                        xanchor: 'left',
                        x: 0,
                    },
                    xaxis: {
                        type: 'date',
                        rangeslider: { visible: true },
                        showspikes: true,
                        spikemode: 'across',
                        spikecolor: '#94a3b8',
                        spikethickness: 1,
                        gridcolor: 'rgba(203, 213, 225, 0.5)',
                    },
                    yaxis: {
                        type: 'linear',
                        rangemode: 'tozero',
                        autorange: true,
                        zeroline: true,
                        showspikes: true,
                        spikemode: 'across',
                        spikecolor: '#94a3b8',
                        spikethickness: 1,
                        gridcolor: 'rgba(203, 213, 225, 0.5)',
                    },
                };

                const config = {
                    responsive: true,
                    displaylogo: false,
                    modeBarButtonsToAdd: [
                        'drawline',
                        'drawopenpath',
                        'drawclosedpath',
                        'drawcircle',
                        'drawrect',
                        'eraseshape',
                    ],
                };

                Plotly.newPlot(chartContainer, traces, layout, config);

                const linearButton = document.getElementById('balance-scale-linear');
                const logButton = document.getElementById('balance-scale-log');

                const setActiveScaleButton = (scaleType) => {
                    if (linearButton) {
                        linearButton.classList.toggle('active', scaleType === 'linear');
                    }
                    if (logButton) {
                        logButton.classList.toggle('active', scaleType === 'log');
                    }
                };

                const setBalanceScale = (scaleType) => {
                    if (scaleType === 'log') {
                        Plotly.relayout(chartContainer, {
                            'yaxis.type': 'log',
                            'yaxis.autorange': true,
                            'yaxis.rangemode': undefined,
                        });
                        setActiveScaleButton('log');
                        return;
                    }

                    Plotly.relayout(chartContainer, {
                        'yaxis.type': 'linear',
                        'yaxis.autorange': true,
                        'yaxis.rangemode': 'tozero',
                    });
                    setActiveScaleButton('linear');
                };

                if (linearButton) {
                    linearButton.addEventListener('click', () => setBalanceScale('linear'));
                }
                if (logButton) {
                    logButton.addEventListener('click', () => setBalanceScale('log'));
                }

                const setActiveWidthButton = (mode) => {
                    if (oneColumnButton) {
                        oneColumnButton.classList.toggle('active', mode === 'one');
                    }
                    if (fullWidthButton) {
                        fullWidthButton.classList.toggle('active', mode === 'full');
                    }
                };

                const setBalanceWidth = (mode) => {
                    if (!chartsGrid) return;

                    chartsGrid.classList.remove('balance-width-one', 'balance-width-full');
                    if (mode === 'full') {
                        chartsGrid.classList.add('balance-width-full');
                        setActiveWidthButton('full');
                    } else {
                        chartsGrid.classList.add('balance-width-one');
                        setActiveWidthButton('one');
                    }

                    requestAnimationFrame(() => {
                        Plotly.Plots.resize(chartContainer);
                    });
                };

                if (oneColumnButton) {
                    oneColumnButton.addEventListener('click', () => setBalanceWidth('one'));
                }
                if (fullWidthButton) {
                    fullWidthButton.addEventListener('click', () => setBalanceWidth('full'));
                }

                const handleResize = () => {
                    Plotly.Plots.resize(chartContainer);
                };

                window.addEventListener('resize', handleResize);
            };

            buildBalancePlotlyChart();

            const txPoints = txDayData.map(item => ({ x: item.day, y: item.transaction_count }));
            const txChartConfig = {
                type: 'bar',
                data: {
                    datasets: [
                        {
                            label: 'Transactions',
                            data: txPoints,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    parsing: { xAxisKey: 'x', yAxisKey: 'y' },
                    scales: {
                        x: {
                            type: 'time',
                            time: { parser: 'yyyy-MM-dd', unit: 'day', tooltipFormat: 'PP' }
                        },
                        y: {
                            beginAtZero: true,
                            precision: 0
                        }
                    }
                }
            };

            const txCanvas = document.getElementById('transactions-day-chart');
            if (txCanvas) {
                new Chart(txCanvas, txChartConfig);
            }

            if (topIncoming.length) {
                const incomeLabels = topIncoming.map(item => item.entity_name || `Entity #${item.entity_id}`);
                const incomeValues = topIncoming.map(item => item.total_usd);
                const incomeColors = buildEntityColors(topIncoming);

                createVerticalBarChart(
                    'top-incoming-chart',
                    incomeLabels,
                    incomeValues,
                    incomeColors,
                );
            }

            if (topOutgoing.length) {
                const expenseLabels = topOutgoing.map(item => item.entity_name || `Entity #${item.entity_id}`);
                const expenseValues = topOutgoing.map(item => item.total_usd);
                const expenseColors = buildEntityColors(topOutgoing);

                createVerticalBarChart(
                    'top-outgoing-chart',
                    expenseLabels,
                    expenseValues,
                    expenseColors,
                );
            }

            if (topIncomingTags.length) {
                const incomingTagLabels = topIncomingTags.map(item => item.tag_name || `Tag #${item.tag_id}`);
                const incomingTagValues = topIncomingTags.map(item => item.total_usd);
                const incomingTagColors = buildTagColors(topIncomingTags);

                new Chart(
                    document.getElementById('top-incoming-tags-chart'),
                    {
                        type: 'doughnut',
                        data: {
                            labels: incomingTagLabels,
                            datasets: [
                                buildDoughnutDataset(
                                    incomingTagValues,
                                    incomingTagColors.bases,
                                    incomingTagColors.hovers,
                                ),
                            ],
                        },
                        options: buildDoughnutOptions(incomingTagValues),
                    }
                );
            }

            if (topOutgoingTags.length) {
                const outgoingTagLabels = topOutgoingTags.map(item => item.tag_name || `Tag #${item.tag_id}`);
                const outgoingTagValues = topOutgoingTags.map(item => item.total_usd);
                const outgoingTagColors = buildTagColors(topOutgoingTags);

                new Chart(
                    document.getElementById('top-outgoing-tags-chart'),
                    {
                        type: 'doughnut',
                        data: {
                            labels: outgoingTagLabels,
                            datasets: [
                                buildDoughnutDataset(
                                    outgoingTagValues,
                                    outgoingTagColors.bases,
                                    outgoingTagColors.hovers,
                                ),
                            ],
                        },
                        options: buildDoughnutOptions(outgoingTagValues),
                    }
                );
            }
        </script>
        {% endif %}
    </div>
</div>
<div class="transactions-section">
    <h2>Transactions</h2>
    {{ transaction_list(transactions) }}
    {{ pagination_control(page, total, limit) }}
</div>
<div class="transactions-section">
    <h2>Invoices</h2>
    {{ invoice_list(invoices) }}
    {% set invoice_total_pages = ((invoices_total - 1) // invoice_limit) + 1 if invoices_total else 1 %}
    <p class="pagination">
        {% if invoice_page > 1 %}
        {% set prev_page = invoice_page - 1 %}
        <a
            href="{{ request.path }}{{ update_query_params(invoice_page=prev_page, invoice_limit=invoice_limit) }}">Previous</a>
        {% endif %}
        <span>Page {{ invoice_page }} of {{ invoice_total_pages }}</span>
        {% if invoice_page < invoice_total_pages %} {% set next_page=invoice_page + 1 %} <a
            href="{{ request.path }}{{ update_query_params(invoice_page=next_page, invoice_limit=invoice_limit) }}">
            Next</a>
            {% endif %}
    </p>
</div>
{% endblock %}